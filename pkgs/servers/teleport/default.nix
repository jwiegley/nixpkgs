# This file was generated by https://github.com/kamilchm/go2nix v2.0-dev
{ stdenv, buildGoPackage, zip, fetchurl }:

buildGoPackage rec {
  name = "teleport-${version}";
  version = "2.4.0";

  goPackagePath = "github.com/gravitational/teleport";
  subPackages = [ "tool/tctl" "tool/teleport" "tool/tsh" ];
  buildInputs = [ zip ];
  postBuild = ''
    pushd .
    cd $NIX_BUILD_TOP/go/src/github.com/gravitational/teleport
    mkdir -p build
    echo "making webassets"
    make build/webassets.zip
    cat build/webassets.zip >> $NIX_BUILD_TOP/go/bin/teleport
    rm -fr build/webassets.zip
    cd $NIX_BUILD_TOP/go/bin
    zip -q -A teleport
    popd
    '';

  dontStrip = true;

  # This repo has a private submodule "e" which fetchgit cannot handle
  # without failing. Using fetchurl instead on the latest tagged release.
  src = fetchurl {
    url = "https://github.com/gravitational/teleport/archive/v2.4.0.tar.gz";
    sha256 = "01qcr6vml3ias3gbkqjnb5fmc6ap1fd5mi52ygn3agafy63jb5rd";
  };

  meta = {
    description = "A SSH CA management suite";
    homepage = "https://gravitational.com/teleport/";
    license = stdenv.lib.licenses.asl20;
    maintainers = [ stdenv.lib.maintainers.tomberek ];
    platforms = stdenv.lib.platforms.linux;
  };
}
